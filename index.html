<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Погода: Сегодня и на неделю</title>
    <!-- Подключаем Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .weather-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f0f0f0;
            color: #333;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .temp-cold {
            color: #1e90ff;
            font-weight: bold;
        }
        .temp-warm {
            color: #ff4500;
            font-weight: bold;
        }
        .no-data {
            text-align: center;
            color: #888;
            font-style: italic;
        }
        .error {
            color: red;
            text-align: center;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .chart-container {
            margin-top: 20px;
            height: 300px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Погода: Сегодня и на неделю</h1>

    <!-- Выбор даты -->
    <div class="controls">
        <label for="date-picker"><strong>Выберите дату:</strong></label>
        <input type="date" id="date-picker">
        <button onclick="goToDate()">Показать</button>
    </div>

    <!-- Погода на сегодня -->
    <h2>Погода на выбранную дату</h2>
    <div id="today-weather">Загрузка данных...</div>

    <!-- Прогноз на неделю (таблица) -->
    <h2>Прогноз на неделю</h2>
    <div id="weekly-forecast">Загрузка...</div>

    <!-- График температуры -->
    <h2>График температуры на неделю</h2>
    <div class="chart-container">
        <canvas id="tempChart"></canvas>
    </div>
</div>

<script>
        // Глобальные переменные
        let weatherData = [];
        let tempChart = null;

        // Форматируем дату в строку "YYYY;M;D"
        function formatDateKey(year, month, day) {
            return `${year};${month};${day}`;
        }

        // Форматируем дату в "YYYY-MM-DD" для input[type="date"]
        function toInputDate(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // Парсим CSV
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(';').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';').map(v => v.trim().replace(/^"(.*)"$/, '$1'));
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                data.push(entry);
            }
            return data;
        }

        // Загрузка CSV
        async function loadCSV() {
            try {
                const response = await fetch('weather.csv');
                if (!response.ok) throw new Error('Файл не найден');
                const text = await response.text();
                weatherData = parseCSV(text);

                // Устанавливаем сегодняшнюю дату в поле выбора
                const today = new Date();
                document.getElementById('date-picker').value = toInputDate(
                    today.getFullYear(),
                    today.getMonth() + 1,
                    today.getDate()
                );

                // Отображаем данные
                updateAll();
            } catch (error) {
                document.getElementById('today-weather').innerHTML = 
                    `<p class="error">Ошибка загрузки: ${error.message}</p>`;
            }
        }

        // Обновить все блоки
        function updateAll() {
            const dateStr = document.getElementById('date-picker').value;
            if (!dateStr) return;

            const [year, month, day] = dateStr.split('-').map(Number);
            displayTodayWeather(year, month, day);
            displayWeeklyForecast();
            createTemperatureChart();
        }

        // Показать погоду на выбранную дату
        function displayTodayWeather(year, month, day) {
            const container = document.getElementById('today-weather');
            const key = formatDateKey(year, month, day);
            const data = weatherData.find(r => 
                parseInt(r.year) === year &&
                parseInt(r.month) === month &&
                parseInt(r.day) === day
            );

            if (data) {
                container.innerHTML = `
                    <div class="weather-card">
                        <p><strong>Дата:</strong> ${day}.${month}.${year}</p>
                        <p><strong>Средняя температура:</strong> 
                            <span class="${data.temperature_avg >= 0 ? 'temp-warm' : 'temp-cold'}">
                                ${data.temperature_avg} °C
                            </span>
                        </p>
                        <p><strong>Минимум:</strong> ${data.temperature_min} °C</p>
                        <p><strong>Максимум:</strong> ${data.temperature_max} °C</p>
                        <p><strong>Осадки:</strong> ${data.precipitation_mm} мм</p>
                        <p><strong>Погода:</strong> ${data.condition}</p>
                    </div>
                `;
            } else {
                container.innerHTML = '<p class="no-data">Нет данных на выбранную дату.</p>';
            }
        }

        // Прогноз на 7 дней вперёд (таблица)
        function displayWeeklyForecast() {
            const container = document.getElementById('weekly-forecast');
            const today = new Date();
            const nextWeek = [];

            for (let i = 1; i <= 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                nextWeek.push({
                    year: d.getFullYear(),
                    month: d.getMonth() + 1,
                    day: d.getDate(),
                    display: `${d.getDate()}.${d.getMonth() + 1}`,
                    key: formatDateKey(d.getFullYear(), d.getMonth() + 1, d.getDate())
                });
            }
            const rows = nextWeek.map(day => {
                const data = weatherData.find(r =>
                    parseInt(r.year) === day.year &&
                    parseInt(r.month) === day.month &&
                    parseInt(r.day) === day.day
                );

                const avg = data ? parseFloat(data.temperature_avg) : null;
                const tempClass = avg !== null ? (avg >= 0 ? 'temp-warm' : 'temp-cold') : '';

                return {
                    date: day.display,
                    avg: data ? `<span class="${tempClass}">${data.temperature_avg}</span>` : '—',
                    min: data ? data.temperature_min : '—',
                    max: data ? data.temperature_max : '—',
                    precipitation: data ? data.precipitation_mm : '—',
                    condition: data ? data.condition : '—'
                };
            });

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Средняя<br>темп. (°C)</th>
                            <!--    <th>Мин. (°C)</th>      -->
                            <!--    <th>Макс. (°C)</th>     -->
                            <th>Осадки (мм)</th>
                            <th>Погода</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rows.forEach(row => {
                tableHTML += `
                    <tr>
                        <td><strong>${row.date}</strong></td>
                        <td>${row.avg}</td>
                        <!--    <td>${row.min}</td>     -->
                        <!--    <td>${row.max}</td>     -->
                        <td>${row.precipitation}</td>
                        <td>${row.condition}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = rows.some(r => r.avg !== '—')
                ? tableHTML
                : '<p class="no-data">Нет данных на ближайшую неделю.</p>';
        }

        // Создание графика температуры на неделю
        function createTemperatureChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            const today = new Date();
            const labels = [];
            const avgTemps = [];
            const minTemps = [];
            const maxTemps = [];

            for (let i = 1; i <= 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const key = formatDateKey(d.getFullYear(), d.getMonth() + 1, d.getDate());
                labels.push(`${d.getDate()}.${d.getMonth() + 1}`);

                const data = weatherData.find(r =>
                    parseInt(r.year) === d.getFullYear() &&
                    parseInt(r.month) === d.getMonth() + 1 &&
                    parseInt(r.day) === d.getDate()
                );

                avgTemps.push(data ? parseFloat(data.temperature_avg) : null);
                minTemps.push(data ? parseFloat(data.temperature_min) : null);
                maxTemps.push(data ? parseFloat(data.temperature_max) : null);
            }

            // Уничтожаем старый график, если есть
            if (tempChart) {
                tempChart.destroy();
            }

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Средняя температура (°C)',
                            data: avgTemps,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Минимальная температура (°C)',
                            data: minTemps,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderDash: [5, 5],
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Максимальная температура (°C)',
                            data: maxTemps,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} °C`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Температура (°C)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Дата'
                            }
                        }
                    }
                }
            });
        }

        // Переход к выбранной дате
        function goToDate() {
            updateAll();
        }

        // Загружаем данные при загрузке страницы
        window.onload = loadCSV;
    </script>
</body>
</html>